<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <title>Async Loader</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="HTML is the foundation of the World Wide Web, and it is still the most popular markup language in use today.">
  <meta name="view-transition" content="same-origin">
  <link rel="stylesheet" href="/base.css">

	<style>
		/* custom error styles */
		async-loader::part(critical) {
			--async-loader-error-bg: light-dark(red, white);
			--async-loader-error-c: light-dark(white, red);
		}
		async-loader::part(warning) {
			--async-loader-error-bg: light-dark(darkorange, white);
			--async-loader-error-c: light-dark(white, darkorange);
		}
	</style>
</head>
<body>
  <h1>UI: Components</h1>

  <h2>Async Loader</h2>
  <p>Displays a loading spinner with optional timeout and error handling.</p>

	<p><button type="button" onclick="showLoader('', 2000)">Basic Loading (2s)</button></p>
	<p><button type="button" onclick="showLoader('allowclose, errormsg:The operation timed out after 1 second, timeout:3000')">Timeout Example (3s)</button></p>
	<p><button type="button" onclick="showWarningError()">Warning Error</button></p>
	<p><button type="button" onclick="showCriticalError()">Critical Error</button></p>
	<p><button type="button" onclick="showLoader('allowclose')">Closable Loader</button></p>
	<p>
		<button type="button" onclick="showInlineLoader(this)">
			<async-loader inline></async-loader>
			Inline Success
		</button>
	</p>
	<p>
		<button type="button" onclick="showInlineLoader(this, true)">
			<async-loader inline timeout="2000"></async-loader>
			Inline Failed
		</button>
	</p>

  <script src="./index.js" type="module"></script>

	<script>
    const loader = document.createElement('async-loader');
    document.body.appendChild(loader);

		function showLoader(attributes = '', timeout = 0) {
      // Remove all existing attributes
      ['allowclose', 'errormsg', 'errortype', 'timeout'].forEach(attr => {
        loader.removeAttribute(attr);
      });

      // Only process attributes if non-empty string is provided
      if (attributes.trim()) {
        attributes.split(',').forEach(attr => {
          attr = attr.trim();
          if (attr.includes(':')) {
            const [name, value] = attr.split(':');
            loader.setAttribute(name.trim(), value.trim());
          } else {
            loader.setAttribute(attr, '');
          }
        });
      }

      loader.dispatchEvent(new CustomEvent('loader:start'));
      if (timeout) {
        setTimeout(() => {
          loader.dispatchEvent(new CustomEvent('loader:stop'));
        }, timeout);
      }
    }

    // Basic loading example
    function showBasicLoader() {
      loader.removeAttribute('allowclose');
      loader.removeAttribute('timeout');
      loader.dispatchEvent(new CustomEvent('loader:start'));
      
      setTimeout(() => {
        loader.dispatchEvent(new CustomEvent('loader:stop'));
      }, 2000);
    }

    // Timeout example
    function showTimeoutLoader() {
      loader.setAttribute('timeout', '3000');
      loader.setAttribute('errormsg', 'The operation timed out after 1 second');
      loader.setAttribute('allowclose', '');
		  loader.dispatchEvent(new CustomEvent('loader:start'));
    }

    // Error example
    async function showErrorLoader() {
      loader.setAttribute('allowclose', '');
      loader.removeAttribute('timeout');
      loader.dispatchEvent(new CustomEvent('loader:start'));

      try {
        // Simulate a failed fetch
        const response = await fetch('/nonexistent-endpoint');
        if (!response.ok) throw new Error('Failed to load data');
      } 
      catch (error) {
        loader.handleError(new Error('Network request failed. Please try again.'));
      }
    }

    // Closable loader example
    function showClosableLoader() {
      loader.setAttribute('allowclose', '');
      loader.removeAttribute('timeout');
      loader.dispatchEvent(new CustomEvent('loader:start'));
    }

    // Warning error example
    function showWarningError() {
      loader.setAttribute('allowclose', '');
      loader.setAttribute('errortype', 'warning');
      loader.dispatchEvent(new CustomEvent('loader:start'));
      loader.handleError(new Error('This is a warning message'));
    }

    // Critical error example
    function showCriticalError() {
      loader.setAttribute('allowclose', '');
      loader.setAttribute('errortype', 'critical');
      loader.dispatchEvent(new CustomEvent('loader:start'));
      loader.handleError(new Error('A critical error occurred'));
    }

    // Inline loader example
    function showInlineLoader(button, raiseError = false) {	
      const inlineLoader = button.querySelector('async-loader');
      inlineLoader.dispatchEvent(new CustomEvent('loader:start'));
			if (raiseError) return;
      setTimeout(() => {
        inlineLoader.dispatchEvent(new CustomEvent('loader:stop'));
      }, 2000);
    }
  </script>

</body>
</html>