<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
	<title>UI</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<meta name="description" content="browser.style: input range">
	<meta name="format-detection" content="telephone=no">
	<link rel="icon" type="image/png" href="/favicon.ico" sizes="any">
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
	<link rel="stylesheet" href="/main.css">
	<link rel="stylesheet" href="/css/tags/output.css">
	<link rel="stylesheet" href="/css/variants/fieldset.css">
	<link rel="stylesheet" href="/css/variants/input.range.css">

	<style>
		body { block-size: 100vh; display: grid; gap: 2ch; grid-template-columns: 15em 1fr 20em;margin: 0; }
		aside { background-color: hsl(0, 0%, 95%); block-size: 100%; overflow-y: scroll; padding: 1ch; }
		#json { font-family: ui-monospace, monospace; font-size: small;}
	</style>
</head>
<body>
	<aside id="list"></aside>
	<form id="app" novalidate></form>
	<aside>
		<code id="json"></code>
		<code id="tagcode"></code>
		<div id="tag"></div>
	</aside>

<script type="module">
import { GLOBAL } from '/attributes_global.js';
import { TAGS } from './tags.mjs';

const CSSPROPS = {
	scope: { 
		name: 'data-scope',
		type: 'select',
		values: [
			'fieldset',
			'form',
			'next',
			'parent',
			'previous',
			'root',
			'self'
		]
	},
	key : {
		name: 'data-key',
		type: 'text'
	},
	unit : {
		name: 'data-unit',
		type: 'text'
	},
	output: { 
		name: 'data-output',
		type: 'select',
		values: [
			'fieldset',
			'form',
			'next',
			'parent',
			'previous',
			'root',
			'self'
		]
	},
	outputUnit : {
		name: 'data-output-unit',
		type: 'text'
	}
}

function attribute(obj) {
	if (!obj.value) return;
	return obj.value === obj.name ? obj.name : `${obj.name}="${obj.value}"`;
}

const selfClosing = (tag) => ['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr'].includes(tag);

function renderAttributes(array) {
	return array.map(attr => `
		${attr.type !== 'hidden' ? `<label>${attr.type !== 'checkbox' ? attr.name:''}`:''}
		${attr.type !== 'select' ? `<input name="${attr.name}" type="${attr.type}" value="${attr.value||''}">` : `<select name="${attr.name}"><option value="">—none—</option>${attr.values.map(option => `<option value="${option}">${option}</option>`).join('')}</select>`}
		${attr.type !== 'hidden' ? `${attr.type === 'checkbox' ? attr.name:''}</label>`:''}
		`).join('');
	}

function renderTag(obj) {
	return `<${obj.tag} ${obj.attributes.map(attr => attribute(attr)).join(' ')}>${!selfClosing(obj.tag) ? `CONTENT ...</${obj.tag}>`:''}`
	/* if (obj.children.length) */
}

function configTag(key) {
	const obj = TAGS[key];
	if (!obj) return;
	return `
	<fieldset name="${obj.tag}" data-bs="vertical">
		<legend>${obj.name}</legend>
		${renderAttributes(obj.attributes)}
		<details>
			<summary>Global attributes</summary>
			<fieldset>
				${renderAttributes([...Object.values(GLOBAL)])}
			</fieldset>
		</details>
		<details>
			<summary>CSS Properties</summary>
			<fieldset>
				${renderAttributes([...Object.values(CSSPROPS)])}
			</fieldset>
		</details>
		<button type="submit">Generate JSON</button>
	</fieldset>`
}

function formToJSON(form) {
	const attributes = [];
	const tag = form.firstElementChild.name || 'input';
	[...form.elements].forEach(input => {
		if (input.value) {
			const obj = { 
				name: input.name,
				value: input.checked ? input.name : input.value
			}
			if (input.type === 'checkbox' && !input.checked) return;
			attributes.push(obj);
		}
	})
	return JSON.stringify({ tag, attributes });
}



/* DEMO */
let str='';
for (const [key, value] of Object.entries(TAGS)) {
  str+= `<details><summary>${key}</summary><div><button type="button" data-tag="${key}">Configure</button></div></details>`;
}
list.innerHTML = str;
list.addEventListener('click', (event) => {
	if (event.target.dataset.tag) app.innerHTML = configTag(event.target.dataset.tag);
})

app.addEventListener('submit', (event) => {
	event.preventDefault();
	const str = formToJSON(app);
	json.innerHTML = str + `<p><button type="button" data-json='${str}''>Render Tag</button></p>`
})

json.addEventListener('click', (event) => {
	if (event.target.dataset.json) {
		const obj = JSON.parse(event.target.dataset.json);
		tagcode.innerHTML = renderTag(obj).replaceAll('<', '&lt;').replaceAll('>', '&gt;');
		tag.innerHTML = renderTag(obj)
	}
})
</script>

<!-- <script src="/main.js" defer></script>
<script src="/js/form.js" defer></script> -->

</body>
</html>